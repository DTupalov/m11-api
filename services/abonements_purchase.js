'use strict';

const request = require('request');
const cheerio = require('cheerio');
const qs = require('querystring');
const ParameterRequiredError = require('../utils/Error').ParameterRequiredError;
const PurchaseError = require('../utils/Error').PurchaseError;

module.exports = function (session, options) {
    return new Promise(function (resolve, reject) {

        let data = {
            account_id : options.account_id,
            contract_id: options.contract_id,
            pan_id     : options.pan_id,
            fairPrice  : options.fairPrice,
            quantity   : options.quantity,
            direction  : options.direction,
            agreement  : options.agreement
        };

        if (!session || !data.account_id || !data.contract_id || !data.pan_id || !data.fairPrice || !data.quantity || !data.direction || !data.agreement) {
            reject(new ParameterRequiredError());
            return;
        }

        let result = [];
        let uri = 'https://private.15-58m11.ru/onyma/oss_task_list/form-action/';

        let cookieJAR = request.jar();
        cookieJAR.setCookie('onm_group=' + session.onm_group, uri);
        cookieJAR.setCookie('onm_session=' + session.onm_session, uri);

        /**
         * direction:
         *  - 3100940000000000000021 - Абонемент на 10 поездок, 1 класс, Москва - Зеленоград
         *  - 3100940000000000000022 - Абонемент на 10 поездок, 1 класс, Москва - ММК (А107)
         *  - 3100940000000000000023 - Абонемент на 10 поездок, 1 класс, Москва - Солнечногорск
         *  - 3100940000000000000020 - Абонемент на 10 поездок, 1 класс, Москва - Шереметьево-2
         *  - 3100940000000000000024 - Абонемент на 10 поездок, 1 класс, Шереметьево-2 - Зеленоград
         *  - 3100940000000000000025 - Абонемент на 10 поездок, 1 класс, Шереметьево-2 - ММК (А107)
         *  - 3100940000000000000026 - Абонемент на 10 поездок, 1 класс, Шереметьево-2 -
         * Солнечногорск
         *
         *  - 3100940000000000000028 - Абонемент на 20 поездок, 1 класс, Москва - Зеленоград
         *  - 3100940000000000000029 - Абонемент на 20 поездок, 1 класс, Москва - ММК (А107)
         *  - 3100940000000000000030 - Абонемент на 20 поездок, 1 класс, Москва - Солнечногорск
         *  - 3100940000000000000027 - Абонемент на 20 поездок, 1 класс, Москва - Шереметьево-2
         *  - 3100940000000000000031 - Абонемент на 20 поездок, 1 класс, Шереметьево-2 - Зеленоград
         *  - 3100940000000000000032 - Абонемент на 20 поездок, 1 класс, Шереметьево-2 - ММК (А107)
         *  - 3100940000000000000033 - Абонемент на 20 поездок, 1 класс, Шереметьево-2 -
         * Солнечногорск
         *
         *  - 3100940000000000000035 - Абонемент на 30 поездок, 1 класс, Москва - Зеленоград
         *  - 3100940000000000000036 - Абонемент на 30 поездок, 1 класс, Москва - ММК (А107)
         *  - 3100940000000000000037 - Абонемент на 30 поездок, 1 класс, Москва - Солнечногорск
         *  - 3100940000000000000034 - Абонемент на 30 поездок, 1 класс, Москва - Шереметьево-2
         *  - 3100940000000000000038 - Абонемент на 30 поездок, 1 класс, Шереметьево-2 - Зеленоград
         *  - 3100940000000000000039 - Абонемент на 30 поездок, 1 класс, Шереметьево-2 - ММК (А107)
         *  - 3100940000000000000040 - Абонемент на 30 поездок, 1 класс, Шереметьево-2 -
         * Солнечногорск
         *
         *  fairPrice:
         *  - 0 - Списывать всегда из абонемента
         *  - 1 - Списывать с баланса, если дешевле
         *
         *  quantity:
         *  - 10
         *  - 20
         *  - 30
         *
         *  agreement:
         *   - 0 - не согласен
         *   - 1 - согласен
         *
         */

        request({
            method: 'POST',
            uri   : uri + '?' + qs.stringify({
                __parent_obj__: data.account_id, // Идентификатор личности '3100520000000000006813'
            }),
            jar   : cookieJAR,
            headers: {
                'Accept'          : 'application/json, text/javascript, */*; q=0.01',
                'X-Requested-With': 'XMLHttpRequest'
            },
            form  : {
                'a$3100420000000000000771'    : data.contract_id, // Договор - необязательно, хотя
                // почему - непонятно
                // '3100910000000000006853'
                'a$3100420000000000000772'    : data.pan_id, // ЭСО - обязательно (идентификатор
                // транспондера) '3100980000000000010732'
                'a$3100420000000000000773'    : data.fairPrice, // Честная цена - необязательно, но
                                                                // учше
                // подставлять (0 - Списывать всегда из
                // абонемента, 1 - Списывать с баланса,
                // если дешевле)
                'a$3100420000000000000767'    : '1', // Класс ТС - обязательно
                'a$3100420000000000000768'    : data.quantity, // Кол-во поездок - обязательно
                // (Доступные значения: 10, 20, 30)
                'a$3100420000000000000769'    : data.direction, // Направление - обязательно (ниже
                                                                // будет
                // описано соответствие id и
                // направлений) '3100940000000000000021'
                's$agreement'                 : data.agreement, // Соглашение - обязательно (0 - не
                // согласен, 1 - согласен)
                'pmodel_id'                   : '3101270000000000000033', // обязательно (id модели
                                                                          // к данным этой формы
                                                                          // наверное хз..)
                'final'                       : '1', // обязательно (тоже какой-то ключ, что
                                                     // финальный сабмит прошел)
                'action_100110000000000000506': '1' // обязательно (тоже какой-то ключ для формы их
                                                    // внутренний)
            }
        }, (error, response, body) => {

            /**
             * Пример успешного ответа
             */
            /*
            body = JSON.stringify({
                "blocks": [1, 2, 4],
                "form_id": "3100620000000000000324",
                "links": [{
                    "is_default": false,
                    "ilink_id": "3100100000000000000099",
                    "href": "/onyma/rm/party/contract_product/?_process_id=3101350000000000107228&__ilink_id__=3100100000000000000099&process_id=3101350000000000107228",
                    "show_near": false,
                    "label": ""
                }],
                "object_link_header": "Объект",
                "actions": [],
                "action_url": "/onyma/oss_task_list/form-action/object-3101360000000000206357/?__parent_obj__=3100520000000000006813",
                "aggregated_data": null,
                "row": "",
                "show_header": false,
                "rows": {
                    "3101360000000000206357": ["<td ><a href=\"/onyma/oss_task_list/3101360000000000206357/?__parent_obj__=3100520000000000006813\">31.136.206357</a></td><td>Подключение абонемента</td><td>Подключение абонемента/Подключить абонемент</td><td>27.08.2016 13:50</td><td>27.08.2016 13:50</td>", {
                        "data-obj-id": "3101360000000000206357",
                        "class": "simple rc2016-08-27 rc13:50:42.465593"
                    }, {
                        "pstep_id_rid": "AAAXSTAAKAAAcckAAM",
                        "task_id": "3101360000000000206357",
                        "pstep_id": "3101290000000000000094",
                        "rid#": "3101360000000000206357",
                        "pstep_id_tuple": ["3101290000000000000094", "Подключение абонемента/Подключить абонемент", "AAAXSTAAKAAAcckAAM"],
                        "task_name_int": "Подключение абонемента",
                        "process_id": "3101350000000000107228",
                        "pstep_id_name": "Подключение абонемента/Подключить абонемент",
                        "task_id_packed": "31.136.206357",
                        "start_dt": "2016-08-27 13:50:42.465593",
                        "end_dt": "2016-08-27 13:50:42.465593",
                        "end_dt_date": "27-AUG-16 01.50.42.465593 PM +03:00",
                        "start_dt_date": "27-AUG-16 01.50.42.465593 PM +03:00"
                    }]
                },
                "form": "\n\n\n\n\n\n\n\n\n<tr>\n    <td style=\"background-color: white\" colspan=\"7\">\n    <div id=\"process-summary-info-3101360000000000206357\" class=\"process-summary-info\">\n        <ul style=\"display:inline; list-style-type: none;\">\n    \n        \n    \n        </ul>\n    </div></td>\n</tr>\n<tr class=\"main-data process-form\">\n    <td colspan=\"8\">\n<div id='main-3101360000000000206357' class='main process-form-main m11-porcess-form-main'>\n    <div id='content-3101360000000000206357' class='content'>\n    \n        \n        <div class=\"formview control c-menu-tabs vertical-tabs m11-menu-tabs\"\n             tabs-container=\".process-info-tabs\"\n        \n        default-tab=\"#process-info-tab-4-3101360000000000206357\">\n        <ul class=\"vertical-tabs\">\n            \n            <li>\n                <a href=\"\"\n                   tab-container='#process-info-tab-4-3101360000000000206357'>Главная</a>\n            </li>\n        \n            \n            \n            \n            \n            \n            \n            \n        </ul>\n        </div>\n        \n    \n\n\n    \n        <div id=\"process-info-tabs-3101360000000000206357\" class=\"process-info-tabs m11-process-info-tabs\"\n              >\n    \n        <div id=\"process-info-tab-4-3101360000000000206357\" class=\"process-info tab tab-4\">\n        \n            \n<table class=\"formtable_flex\">\n\n    \n\n    <tr>\n    <td>\n        <div class=\"flex preview flex-form\">\n            \n                <div class=\"row nowrap\">\n                    \n                        \n                            <div class=\"graybox  column-12-lap column-6-hand offset-0-hand unnamed\"\n                                 \n                                 data-no-minimize=\"1\"\n                                 style=\"background-color: rgb(242, 242, 242);\n                                 \n                                         \n                                         \">\n                                <span class=\"min-block mdi\" title=\"Свернуть блок\"></span>\n                                \n                                    \n                                        <div class=\"control-wrapper align-self_stretch \"\n                                             data-ctrl=\"s$msg_ok\">\n                                            \n                                            \n                                            <span style=\"\" class=\"w-html-ro\"><div class=\"messages\"><div class=\"msg-normal\">Спасибо за покупку! Ваш абонемент успешно оплачен и готов к использованию!</div></div></span><input autocomplete=\"off\" readonly=\"readonly\" name=\"s$msg_ok\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" value=\"&lt;div class=&quot;messages&quot;&gt;&lt;div class=&quot;msg-normal&quot;&gt;Спасибо за покупку! Ваш абонемент успешно оплачен и готов к использованию!&lt;/div&gt;&lt;/div&gt;\" id=\"id_s$msg_ok_c266553e-ad52-42c7-b289-3c25ecd5eba1\" />\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000770\">\n                                            <label for=\"id_a$3100420000000000000770_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Клиент</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><span data-uid=\"OnmLinkSmartSelectDatasource\" data-params=\"{&quot;col_id&quot;:&quot;3100090000000000004603&quot;,&quot;is_cacheable&quot;:&quot;&quot;,&quot;need_where&quot;:true,&quot;link_id&quot;:&quot;3100100000000000000552&quot;}\" class=\"control c-smartselect\" data-combomode=\"False\" data-column-name=\"a$3100420000000000000770\"><span class=\"w-text-ro\">Тупалов Дмитрий Дмитриевич</span><input name=\"a$3100420000000000000770\" value=\"3100520000000000006813\" autocomplete=\"off\" readonly=\"readonly\" type=\"hidden\" id=\"id_a$3100420000000000000770_c266553e-ad52-42c7-b289-3c25ecd5eba1\" />&nbsp;<a tabindex=\"-1\" href=\"/onyma/rm/party/AAAXS9AAKAAB0bvAAv/\" class=\"selectedlink outerlink\" target=\"_blank\">...</a></span></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000771\">\n                                            <label for=\"id_a$3100420000000000000771_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Договор</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><span data-uid=\"OnmLinkSmartSelectDatasource\" data-params=\"{&quot;col_id&quot;:&quot;3100090000000000004604&quot;,&quot;is_cacheable&quot;:&quot;&quot;,&quot;need_where&quot;:true,&quot;link_id&quot;:&quot;3100100000000000000549&quot;}\" class=\"control c-smartselect\" data-combomode=\"False\" data-column-name=\"a$3100420000000000000771\"><span class=\"w-text-ro\">6747</span><input name=\"a$3100420000000000000771\" value=\"3100910000000000006853\" id=\"id_a$3100420000000000000771_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" readonly=\"readonly\" data-where-depends=\"parent_obj_id\" type=\"hidden\" class=\"control c-where-depends\" />&nbsp;<a tabindex=\"-1\" href=\"/onyma/lk/account/AAAXS3AAKAAB0yxAAl/\" class=\"selectedlink outerlink\" target=\"_blank\">...</a></span></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000772\">\n                                            <label for=\"id_a$3100420000000000000772_c266553e-ad52-42c7-b289-3c25ecd5eba1\">ЭСО</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><span data-uid=\"OnmLinkSmartSelectDatasource\" data-params=\"{&quot;col_id&quot;:&quot;3100090000000000004651&quot;,&quot;is_cacheable&quot;:&quot;&quot;,&quot;need_where&quot;:true,&quot;link_id&quot;:&quot;3100100000000000000550&quot;}\" class=\"control c-smartselect\" data-combomode=\"False\" data-column-name=\"a$3100420000000000000772\"><span class=\"w-text-ro\">6058425000000129626</span><input name=\"a$3100420000000000000772\" value=\"3100980000000000010732\" id=\"id_a$3100420000000000000772_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" readonly=\"readonly\" data-where-depends=\"a$3100420000000000000771\" type=\"hidden\" class=\"control c-where-depends\" />&nbsp;<a tabindex=\"-1\" href=\"/onyma/rm/party/contract_product/AAAXTSAAKAABz0uAAf/\" class=\"selectedlink outerlink\" target=\"_blank\">...</a></span></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000775\">\n                                            <label for=\"id_a$3100420000000000000775_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Баланс договора</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><span style=\"\" data-suffix=\"\" data-prefix=\"\" data-decimal-separator=\",\" data-decimal-positions=\"2\" class=\"w-text-ro-fn\" data-thousand-separator=\" \"></span><input data-column-id=\"3100090000000000004652\" data-call-id=\"3100530000000000001789\" type=\"hidden\" data-eval-calculated=\"true\" class=\"control w-text c-eval-depends\" autocomplete=\"off\" readonly=\"readonly\" data-eval-depends=\"a$3100420000000000000771\" id=\"id_a$3100420000000000000775_c266553e-ad52-42c7-b289-3c25ecd5eba1\" name=\"a$3100420000000000000775\" /></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                            </div>\n                        \n                    \n                        \n                            <div class=\"graybox  column-12-lap column-6-hand offset-0-hand unnamed\"\n                                 \n                                 data-no-minimize=\"1\"\n                                 style=\"background-color: rgb(242, 242, 242);\n                                 \n                                         \n                                         \">\n                                <span class=\"min-block mdi\" title=\"Свернуть блок\"></span>\n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000773\">\n                                            <label for=\"id_a$3100420000000000000773_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Опция &quot;Честная цена&quot;</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><div data-uid=\"OnmRefSmartSelectDatasource\" data-params=\"{&quot;ref_field_id&quot;:&quot;3100090000000000004661&quot;,&quot;need_where&quot;:false,&quot;ref_id&quot;:&quot;3100040000000000000084&quot;}\" class=\"control c-radio-buttons\"><ul>\n<li><label for=\"id_a$3100420000000000000773_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000773_radio\" type=\"radio\" id=\"id_a$3100420000000000000773_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\" value=\"0\" /> Списывать всегда из абонемента</label></li>\n<li><label for=\"id_a$3100420000000000000773_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_1\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" checked=\"checked\" name=\"a$3100420000000000000773_radio\" type=\"radio\" id=\"id_a$3100420000000000000773_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_1\" value=\"1\" /> Списывать с баланса, если дешевле</label></li>\n</ul><div style=clear:both ></div><input name=\"a$3100420000000000000773\" datasource_factory=\"&lt;onm.forms.datasources.OnmRefSmartSelectDatasourceFactory object at 0x7fdbd31c4910&gt;\" value=\"1\" id=\"id_a$3100420000000000000773_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" readonly=\"readonly\" type=\"hidden\" class=\"w-text\" /></div></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"s$pkg_application\">\n                                            <label for=\"id_s$pkg_application_c266553e-ad52-42c7-b289-3c25ecd5eba1\"> </label>\n                                            \n                                            <span style=\"\" class=\"w-html-ro\"><a href='/documentum/servlet?skey=11697634:8cqcQfvX6MkQUhbRWxoEIA7IPYthFnte&doc_fix=0&dk_id=3101040000000000000480&parm_val[OSS_PROCESS_ID]=3101350000000000107228&dsf_id=3102580000000000001821' target=\"_blank\">\n\t<div style='display: block; float:left; padding: 0 7px; border: 1px solid #ccc; margin-right:4px;'>\n\t\t<img src='/media/core/imgs/down.gif'/>\n\t\t<span style='margin-left: 3px; color: #444;'>Скачать заявление</span>\n\t</div>\n</a></span><input autocomplete=\"off\" readonly=\"readonly\" name=\"s$pkg_application\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" value=\"&lt;a href=&#39;/documentum/servlet?skey=11697634:8cqcQfvX6MkQUhbRWxoEIA7IPYthFnte&amp;doc_fix=0&amp;dk_id=3101040000000000000480&amp;parm_val[OSS_PROCESS_ID]=3101350000000000107228&amp;dsf_id=3102580000000000001821&#39; target=&quot;_blank&quot;&gt;\n\t&lt;div style=&#39;display: block; float:left; padding: 0 7px; border: 1px solid #ccc; margin-right:4px;&#39;&gt;\n\t\t&lt;img src=&#39;/media/core/imgs/down.gif&#39;/&gt;\n\t\t&lt;span style=&#39;margin-left: 3px; color: #444;&#39;&gt;Скачать заявление&lt;/span&gt;\n\t&lt;/div&gt;\n&lt;/a&gt;\" id=\"id_s$pkg_application_c266553e-ad52-42c7-b289-3c25ecd5eba1\" />\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                            </div>\n                        \n                    \n                        \n                    \n                </div>\n            \n                <div class=\"row nowrap\">\n                    \n                        \n                    \n                        \n                    \n                        \n                            <div class=\"graybox  column-12-lap column-6-hand offset-0-hand unnamed\"\n                                 \n                                 data-no-minimize=\"1\"\n                                 style=\"background-color: rgb(242, 242, 242);\n                                 \n                                         \n                                         \">\n                                <span class=\"min-block mdi\" title=\"Свернуть блок\"></span>\n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000767\">\n                                            <label for=\"id_a$3100420000000000000767_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Класс ТС</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><div data-uid=\"OnmRefSmartSelectDatasource\" data-params=\"{&quot;ref_field_id&quot;:&quot;3100090000000000004654&quot;,&quot;need_where&quot;:true,&quot;ref_id&quot;:&quot;3100040000000000000023&quot;}\" class=\"control horizontal c-radio-buttons\"><ul>\n<li><label for=\"id_a$3100420000000000000767_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" checked=\"checked\" name=\"a$3100420000000000000767_radio\" type=\"radio\" id=\"id_a$3100420000000000000767_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\" value=\"1\" /> I</label></li>\n</ul><div style=clear:both ></div><input name=\"a$3100420000000000000767\" datasource_factory=\"&lt;onm.forms.datasources.OnmRefSmartSelectDatasourceFactory object at 0x7fdbd3b7dd10&gt;\" value=\"1\" id=\"id_a$3100420000000000000767_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" readonly=\"readonly\" type=\"hidden\" class=\"w-text\" /></div></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000768\">\n                                            <label for=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Размер абонемента</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><div data-uid=\"OnmRefSmartSelectDatasource\" data-params=\"{&quot;ref_field_id&quot;:&quot;3100090000000000004664&quot;,&quot;need_where&quot;:false,&quot;ref_id&quot;:&quot;3100040000000000000083&quot;}\" class=\"control horizontal c-radio-buttons\"><ul>\n<li><label for=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" checked=\"checked\" name=\"a$3100420000000000000768_radio\" type=\"radio\" id=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\" value=\"10\" /> 10 поездок</label></li>\n<li><label for=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_1\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000768_radio\" type=\"radio\" id=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_1\" value=\"20\" /> 20 поездок</label></li>\n<li><label for=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_2\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000768_radio\" type=\"radio\" id=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_2\" value=\"30\" /> 30 поездок</label></li>\n</ul><div style=clear:both ></div><input name=\"a$3100420000000000000768\" datasource_factory=\"&lt;onm.forms.datasources.OnmRefSmartSelectDatasourceFactory object at 0x7fdbd3393610&gt;\" value=\"10\" id=\"id_a$3100420000000000000768_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" readonly=\"readonly\" type=\"hidden\" class=\"w-text\" /></div></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000769\">\n                                            <label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Абонемент</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><div data-uid=\"OnmLinkSmartSelectDatasource\" data-params=\"{&quot;col_id&quot;:&quot;3100090000000000004665&quot;,&quot;is_cacheable&quot;:&quot;&quot;,&quot;need_where&quot;:true,&quot;link_id&quot;:&quot;3100100000000000000551&quot;}\" class=\"control c-radio-buttons\"><ul>\n<li><label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000769_radio\" type=\"radio\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_0\" value=\"3100940000000000000021\" /> Абонемент на 10 поездок, 1 класс, Москва - Зеленоград</label></li>\n<li><label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_1\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000769_radio\" type=\"radio\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_1\" value=\"3100940000000000000022\" /> Абонемент на 10 поездок, 1 класс, Москва - ММК (А107)</label></li>\n<li><label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_2\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" checked=\"checked\" name=\"a$3100420000000000000769_radio\" type=\"radio\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_2\" value=\"3100940000000000000023\" /> Абонемент на 10 поездок, 1 класс, Москва - Солнечногорск</label></li>\n<li><label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_3\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000769_radio\" type=\"radio\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_3\" value=\"3100940000000000000020\" /> Абонемент на 10 поездок, 1 класс, Москва - Шереметьево-2</label></li>\n<li><label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_4\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000769_radio\" type=\"radio\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_4\" value=\"3100940000000000000024\" /> Абонемент на 10 поездок, 1 класс, Шереметьево-2 - Зеленоград</label></li>\n<li><label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_5\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000769_radio\" type=\"radio\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_5\" value=\"3100940000000000000025\" /> Абонемент на 10 поездок, 1 класс, Шереметьево-2 - ММК (А107)</label></li>\n<li><label for=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_6\"><input autocomplete=\"off\" disabled=\"disabled\" readonly=\"readonly\" name=\"a$3100420000000000000769_radio\" type=\"radio\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1_radio_6\" value=\"3100940000000000000026\" /> Абонемент на 10 поездок, 1 класс, Шереметьево-2 - Солнечногорск</label></li>\n</ul><div style=clear:both ></div><input name=\"a$3100420000000000000769\" datasource_factory=\"&lt;onm.forms.datasources.OnmLinkSmartSelectDatasourceFactory object at 0x7fdbd3253890&gt;\" value=\"3100940000000000000023\" id=\"id_a$3100420000000000000769_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" readonly=\"readonly\" data-where-depends=\"a$3100420000000000000768|a$3100420000000000000772|a$3100420000000000000767\" type=\"hidden\" class=\"control w-text c-where-depends\" /></div></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000779\">\n                                            <label for=\"id_a$3100420000000000000779_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Стоимость одной поездки</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><span style=\"\" data-suffix=\"\" data-prefix=\"\" data-decimal-separator=\",\" data-decimal-positions=\"2\" class=\"w-text-ro-fn\" data-thousand-separator=\" \"></span><input data-column-id=\"3100090000000000004657\" data-call-id=\"3100530000000000001784\" type=\"hidden\" data-eval-calculated=\"true\" class=\"control w-text c-eval-depends\" autocomplete=\"off\" readonly=\"readonly\" data-eval-depends=\"a$3100420000000000000769|a$3100420000000000000772\" id=\"id_a$3100420000000000000779_c266553e-ad52-42c7-b289-3c25ecd5eba1\" name=\"a$3100420000000000000779\" /></div>\n                                            \n                                        </div>\n                                    \n                                \n                                    \n                                \n                                    \n                                        <div class=\"control-wrapper\"\n                                             data-ctrl=\"a$3100420000000000000778\">\n                                            <label for=\"id_a$3100420000000000000778_c266553e-ad52-42c7-b289-3c25ecd5eba1\">Списано с л/с</label>\n                                            \n                                            <div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><span style=\"\" data-suffix=\"\" data-prefix=\"\" data-decimal-separator=\",\" data-decimal-positions=\"2\" class=\"w-text-ro-fn\" data-thousand-separator=\" \">3 000,00</span><input autocomplete=\"off\" readonly=\"readonly\" name=\"a$3100420000000000000778\" type=\"hidden\" class=\"w-text\" value=\"3000\" id=\"id_a$3100420000000000000778_c266553e-ad52-42c7-b289-3c25ecd5eba1\" /></div>\n                                            \n                                        </div>\n                                    \n                                \n                            </div>\n                        \n                    \n                </div>\n            \n        </div>\n    </td>\n</tr>\n</table>\n\n        \n        </div>\n    \n        \n            \n            <div id=\"process-info-tab-105-3101360000000000206357\" class=\"process-info tab\">\n            </div>\n            <div id=\"process-info-tab-106-3101360000000000206357\" class=\"process-info tab\">\n            </div>\n            <div id=\"process-info-tab-104-3101360000000000206357\" class=\"process-info tab\">\n            </div>\n        \n    </div>\n    \n\n</div>\n<div class=\"process actions bottom control c-actions-container m11-process-bottom-actions\">\n\n    \n    \n    \n    \n\n    \n    <span class=form-id>3100620000000000000324</span>\n</div>\n\n    \n\n    <div style=\"clear: both\"></div>\n</div>\n</td>\n</tr>\n    \n    <tr class=\"actions-bar-container\">\n        <td colspan=\"7\">\n            \n            <div class=\"content\">\n                \n                    <div class=\"process actions\">\n                        \n                            \n                        \n                        \n                        \n                        <span class=form-id>3100620000000000000324</span>\n                        \n                    </div>\n                \n            </div>\n        </td>\n    </tr>\n<tr class=\"hidden-fields\" style=\"display:none\">\n    <td><div class=\"control c-attrlink\" readonly=\"readonly\" data-readonly=\"readonly\"><input name=\"a$100420000000000000412\" value=\"3101350000000000107228\" id=\"id_a$100420000000000000412_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" readonly=\"readonly\" type=\"hidden\" class=\"w-text\" /></div><input data-auto-refresh-on=\"[&quot;*&quot;]\" data-can-change-form=\"true\" datasource_factory=\"&lt;onm.forms.datasources.OnmLinkSmartSelectDatasourceFactory object at 0x7fdbd31c48d0&gt;\" required=\"required\" value=\"3101270000000000000033\" id=\"id_pmodel_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" is_combo=\"False\" link_pattern=\"\" type=\"hidden\" class=\"w-text\" name=\"pmodel_id\" /><input data-auto-refresh-on=\"[&quot;*&quot;]\" data-can-change-form=\"true\" id=\"id_s$pmodel_arg_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" name=\"s$pmodel_arg\" /><input data-can-change-form=\"true\" is_combo=\"False\" class=\"control c-where-depends\" data-auto-refresh-on=\"[&quot;*&quot;]\" name=\"class_id\" datasource_factory=\"&lt;onm.forms.datasources.OnmLinkSmartSelectDatasourceFactory object at 0x7fdbd31c43d0&gt;\" required=\"required\" value=\"3100410000000000000153\" id=\"id_class_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" data-where-depends=\"pmodel_id\" link_pattern=\"\" type=\"hidden\" /><input data-auto-refresh-on=\"[&quot;*&quot;]\" data-can-change-form=\"true\" datasource_factory=\"&lt;onm.forms.datasources.OnmLinkSmartSelectDatasourceFactory object at 0x7fdbd31c4f90&gt;\" required=\"required\" value=\"101310000000000000001\" id=\"id_sla_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" is_combo=\"False\" link_pattern=\"\" type=\"hidden\" class=\"w-text\" name=\"sla_id\" /><input std_format=\"%Y-%m-%d %H:%M:%S.%f\" name=\"start_dt\" format=\"%d.%m.%Y %H:%M:%S\" value=\"2016-08-27 13:50:42.443768 +0300\" id=\"id_start_dt_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" /><input data-auto-refresh-on=\"[&quot;*&quot;]\" data-can-change-form=\"true\" datasource_factory=\"&lt;onm.forms.datasources.OnmLinkSmartSelectDatasourceFactory object at 0x7fdbd30c9990&gt;\" required=\"required\" value=\"3100150000000000013808\" id=\"id_group_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" is_combo=\"False\" link_pattern=\"\" type=\"hidden\" class=\"w-text\" name=\"group_id\" /><input name=\"sset_id\" value=\"0\" id=\"id_sset_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" /><input name=\"parent_obj_id\" value=\"3100520000000000006813\" id=\"id_parent_obj_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" /><input name=\"process_id\" value=\"3101350000000000107228\" id=\"id_process_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" /><input name=\"rid\" id=\"id_rid_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" /><input name=\"t$process_id\" value=\"3101350000000000107228\" id=\"id_t$process_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" /><input name=\"t$task_id\" value=\"3101360000000000206357\" id=\"id_t$task_id_c266553e-ad52-42c7-b289-3c25ecd5eba1\" autocomplete=\"off\" iobject_id=\"\" type=\"hidden\" class=\"w-text\" /><input iobject_id=\"\" type=\"hidden\" name=\"g_form_create_time\" value=\"2016-08-27 13:50:43.657438\" id=\"id_g_form_create_time_c266553e-ad52-42c7-b289-3c25ecd5eba1\" /><input type=\"hidden\" name=\"__edited__\" id=\"id___edited___c266553e-ad52-42c7-b289-3c25ecd5eba1\" />\n        \n            \n            \n            <input name=sub_process_count type=hidden value=\"0\">\n        \n    </td>\n</tr>\n\n",
                "success": true,
                "notification": {
                    "message": "0"
                },
                "messages": "\n<div class=\"messages\">\n\n\n<div class=\"message msg-normal\">\n<div>Операция выполнена</div>\n\n\n</div>\n\n\n</div>\n\n",
                "form_path": null,
                "object_id": "3101360000000000206357",
                "id_placeholder": null,
                "readonly": null,
                "params": "{\"cb_col\":false,\"import_url\":\"/onyma/oss_task_list/import-action/?__parent_obj__=3100520000000000006813\",\"field_order_url\":\"/onyma/oss_task_list/field-order/?__parent_obj__=3100520000000000006813\",\"parent_filter_data\":\"\",\"use_tabs_url\":\"/onyma/oss_task_list/use_tabs/?__parent_obj__=3100520000000000006813\",\"reset_order_url\":\"/onyma/oss_task_list/sort/?__parent_obj__=3100520000000000006813\",\"export_field_list\":{\"pmodel_id\":\"Модель процесса\",\"process_id\":\"Процесс\",\"start_dt\":\"Дата начала\",\"user_id\":\"Ответственный \",\"task_id\":\"Id\",\"pstep_id\":\"Шаг\",\"position_id\":\"Позиция\",\"sub_proc_id\":\"Процесс\",\"deadline_dt\":\"Срок выполнения\",\"sset_id\":\"Гриф\",\"parent_obj_id\":\"Родитель\",\"task_name_int\":\"Наименование\",\"curr_user\":\"Участие в процессе\",\"close\":\"Показать просроченные\",\"rid\":\"rowid\",\"group_id\":\" \",\"end_dt\":\"Дата окончания\",\"priority\":\"Приоритет\"},\"field_order\":{\"task_name_int\":2.0,\"start_dt\":6.0,\"end_dt\":7.0,\"pstep_id\":3.0,\"task_id\":1.0},\"field_vis\":{\"task_id\":1,\"task_name_int\":1,\"pstep_id\":1,\"start_dt\":1,\"end_dt\":1},\"tree_view\":false,\"is_open_first_row\":0,\"base_url\":\"/onyma/oss_task_list/?__parent_obj__=3100520000000000006813\",\"tree_url_tpl\":\"/onyma/oss_task_list/?tree_up_id=%25s&__parent_obj__=3100520000000000006813\",\"m2m\":null,\"iobject_id\":\"100070000000000000235\",\"group_by\":null,\"form_url_tpl\":\"/onyma/oss_task_list/%s/?__parent_obj__=3100520000000000006813\",\"inline_filter_enabled\":false,\"use_tabs\":\"\",\"toggle_inline_filter\":\"/onyma/oss_task_list/inline-filter/toggle/?__parent_obj__=3100520000000000006813\",\"can_have_tabs\":0,\"inline_mode\":false,\"has_enabled_add_action\":false,\"inline_col\":false,\"allow_export\":\"101040000000000000048\",\"refresh_url\":\"/onyma/oss_task_list/?__parent_obj__=3100520000000000006813&refresh=1\",\"group_by_url\":\"/onyma/oss_task_list/group-by/?__parent_obj__=3100520000000000006813\",\"list_only\":false,\"expand_tree_level\":0,\"group_by_dir\":\"asc\",\"blinking_field_list\":{\"task_id\":\"Id\",\"task_name_int\":\"Наименование\",\"pstep_id\":\"Шаг\",\"start_dt\":\"Дата начала\",\"end_dt\":\"Дата окончания\"},\"debug_url\":\"\",\"with_row_actions\":false,\"inline_action_url\":null,\"save_inline_filter\":\"/onyma/oss_task_list/inline-filter/save/?__parent_obj__=3100520000000000006813\",\"export_doc_url\":\"/onyma/rm/docs/\",\"export_url\":\"/onyma/oss_task_list/export/?__parent_obj__=3100520000000000006813\",\"export_processors\":{\"mscsv\":\"Export CSV for Excel\",\"json\":\"Export JSON\",\"csv\":\"Export CSV\"},\"field_vis_url\":\"/onyma/oss_task_list/field-vis/?__parent_obj__=3100520000000000006813\",\"list_label\":\"\",\"groupable_field_list\":{\"start_dt:H\":\"Дата начала (Час)\",\"start_dt:D\":\"Дата начала (День)\",\"start_dt:M\":\"Дата начала (Месяц)\",\"start_dt:Y\":\"Дата начала (Год)\"},\"export_options\":{\"deadline_dt\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"group_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"user_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"task_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"pstep_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"position_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"end_dt\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"curr_user\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"pmodel_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"sset_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"process_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"task_name_int\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"parent_obj_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"close\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"rid\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"start_dt\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"sub_proc_id\":{\"do_export\":false,\"as_list\":false,\"order\":99999},\"priority\":{\"do_export\":false,\"as_list\":false,\"order\":99999}},\"inline_add\":false}",
                "not_in_list": false,
                "form_url": "/onyma/oss_task_list/3101360000000000206357/?__parent_obj__=3100520000000000006813"
            });
            */

            if (error) {
                reject(error);
                return;
            }

            try {
                body = JSON.parse(body);
                let isSuccess = body.success === true;
                let $ = cheerio.load(body.messages);

                if (!isSuccess) {
                    let errorMessage = $('.msg-error > div').text();
                    reject(new PurchaseError({message: errorMessage}));
                    return;
                }

                let successMessage = $('.msg-normal > div').text();

                resolve({message: successMessage});
            } catch (e) {
                reject(e);
            }

        });
    })
};